 <div class="container">
<% color1 = "" #neutral 100
   color2 = "" #blue-300

   color3 = "" 
   color4 = ""
    
  cycle = params["cycle"]
  fte = params["fte"]
  bar = params["bar"]
  progress = params["progress"]
  pchart = params["pchart"]
  capacity = params["capacity"]
  
  nameofmonths = ['','Jan', 'Feb','March','April','May','June','July','Aug', 'Sep','Oct','Nov','Dec']
  cur_cycle = Cycle.where("cycle_name LIKE '"+cycle+"'")
  s = cur_cycle.first.start.month
  stmonth = ""
  endmonth = ""
  if (s != nil)
    stmonth = nameofmonths[s]
    if s<=8
      s = s +3
    else
      s = s+3 -12 
    end  
   endmonth = nameofmonths[s]
  end 
  
  s = cur_cycle.first.start.month
  months = ['','','','','']
  i = 1
  while (i<=4) do
    months[i] = nameofmonths[s]
    i = i + 1
    s = s+1 
    if (s>12)
     s= 1
    end
  end 

  @slist = Card.where("activity_type LIKE 'Strategic'")

  #burndown chart data
  

  data_array = []
  legend = []
  strategic_p = [100]

  cur_month = Date.current.month
  cur_dt = Date.current.day
  pos= months.index(nameofmonths[cur_month])
                  
  if (cur_dt < 24) # add curren month only if end of the month
    pos = pos-1
  end 

  ideal_p = [100] 
  i = 0 
  num = 75
  while (i<pos)
     ideal_p << num
     num = num -25
     i = i + 1
  end
  @slist.each do |s|
      strategic_p = [100]
      month1p = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").sum(:status1)
      month2p = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").sum(:status2)
      month3p = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").sum(:status3)
      month4p = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").sum(:status4)  

     cnt1 = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").count
     cnt2 = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").count
     cnt3 = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").count
     cnt4 = Objective.where("card_id='"+s.id.to_s+"' AND cycle='" + cycle +"'").count 

   
     p1 = 100- (month1p/cnt1)
     if (p1 <100)
       strategic_p << p1 
         
     end 
     p2 = 100- (month2p/cnt2)
     if (p2 < 100)
        strategic_p << p2
        
     end 

     p3 = 100- (month3p/cnt3)
     if (p3 < 100)
       strategic_p << p3
       
     end 

     p4 = 100- (month4p/cnt4)
     if (p4 < 100)
       strategic_p << p4
       
     end 

     data_array << strategic_p
     legend << s.short_name
  end  

    graph_months = ['']
    i = 0 
    while (i<pos)
      i = i + 1
      graph_months << months[i]
    end

%>
<div class="container-fluid">
  <h3>  <%=cycle%> (<%= stmonth %>-<%= endmonth %>) Library IT Strategic Projects  </h3>
  <p>(Reflects progress through the month of <%= months[pos] %>)</p>

  <% 

if (capacity) 

 @slist = Card.where("activity_type LIKE 'Strategic'")
 @alist = Card.where("activity_type LIKE '%Active%' ") 

 total_tactical = 0 
 total_strategic = 0 

 @slist.each do |s|
  str = "card_id='" + s.id.to_s + "' AND cycle='"+ cycle + "'"
  ch_cnt = ChipAssignment.where(str).sum(:chips)
  if (ch_cnt.nil?) 
    ch_cnt = 0 
  else  
    ch_cnt = ch_cnt/4 
  end
  total_strategic = total_strategic + ch_cnt
 end 

 @alist.each do |a|
  str = "card_id='" + a.id.to_s + "' AND cycle='"+ cycle + "'"
  ch_cnt = ChipAssignment.where(str).sum(:chips)
  if (ch_cnt.nil?) 
    ch_cnt = 0 
  else  
    ch_cnt = ch_cnt/4 
  end
  total_tactical = total_tactical + ch_cnt
 end 
 
 ch = Chip.order(:dept)
 totalops = 0
 totalpro =0 
 totalstanding = 0 
 ch.each do |t|
  totalops = totalops = totalops + t.ops
  totalpro = totalpro = totalpro + t.project
 end
 
 totalops = totalops*1.0/4
 totalpro = totalpro*1.0/4
 finaltotal = totalops + totalpro
 propercent = (totalpro/finaltotal)*100
 opspercent = (totalops/finaltotal)*100
 
 totalfte = Array.new
 totalfte << totalpro
 totalfte << totalops

 total_standing =  totalpro - (total_strategic+total_tactical)
 tpercent = (total_tactical/totalpro)*100
 spercent = (total_strategic/totalpro)*100
 leftpercent = (total_standing/totalpro)*100
 tact_s = Array.new
 tact_s << total_strategic
 tact_s << total_tactical
 tact_s << total_standing

 
total_cap = Gchart.pie_3d(:title => "Total", :labels => "Ops/Services|Projects/Initiatives", :data => totalfte, :size => '500x200', :line_colors => 'f2c649,16147A')
pro_cap = Gchart.pie_3d(:title => "Projects/Initiatives", :labels => "Strategic|Tactical|Standing", :data => tact_s, :size => '500x200', :line_colors => 'D9D129, BBB424, E9E131')
%>

<p style="padding-top: 5px;" >
</p>
  <div class="card" >
      <div class="card-header" >
        <h5>LIT Capacity </h5>
      </div>
    
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">    
            <p><%= image_tag total_cap%></p>
             <p align="center">Projects/Initiatives: <%=totalpro.round(2) %> FTE, <%=propercent.round(2) %>%  </p>
            <p align="center">Ops/Services: <%=totalops.round(2) %> FTE, <%=opspercent.round(2) %>% </p>
          </div>
          <div class="col-md-6">      
            <p ><%= image_tag pro_cap%></p>
             <p align="center">Strategic: <%=total_strategic.round(2) %> FTE,<%=spercent.round(2) %>% </p>
            <p align="center">Tactical: <%= total_tactical.round(2) %> FTE, <%=tpercent.round(2) %>% </p>
             <p align="center">Standing: <%= total_standing.round(2) %> FTE, <%=leftpercent.round(2) %>% </p>
          </div>  
        </div>  
      </div>
    </div>
  
<% end %>

  <% 
  
  legend <<  'Expected'
  data_array << ideal_p
  if (pchart)
    

    burndown_chart = Gchart.line(
    :size => '700x300',
    :line_colors => '003fff,5886a5,CDCF15,bc5090,ffa600,FFB8AE,00A99A,ff6361,50C878',
    :data => data_array, 
    :legend => legend,
    :title => 'Effort Chart',
    :axis_with_labels => ['x', 'y'], 
    :axis_labels => [graph_months], 
    :axis_range => [nil, [0,100,25]])
  
  %>
  <p style="padding-top:10px"> </p>
  <div class="card">
    <div class="card-header">
      <h5>Progress towards Objectives</h5>
    </div>
  <div class="card-body">    
   <div class="row">
    <div class="col">
      <%= image_tag burndown_chart %>
    </div>
   </div>
  </div> 
 </div> 
 <% end  #if phart%>
   <div class="row" style="padding-top:20px"> 
<% 
 
  card_no = 0
  @slist.all.each do |strategic| 
     total = 0 
     cnt = 0
     card_no = card_no+1

     card_id = strategic.id 
     str = "card_id='" + card_id.to_s + "' AND cycle='"+ cycle + "'"
     @o_st = Objective.where(str) 
     
     @o_st.all.each do |o|   
       # based on current month  
        if (pos==1)
               ostatus = o.status1
             elsif (pos==2)
               ostatus = o.status2
             elsif (pos==3)
               ostatus = o.status3
             elsif (pos==4)
               ostatus = o.status4    
             end  
       cnt = cnt+1 
       if (ostatus != nil)
          total+=ostatus
       end
     end    
    
    if (cnt>0) 
     total = total/cnt 
    else
     total = 0 
    end 
    
   
    t_chips = ChipAssignment.where(str).sum(:chips)
    t_chips = t_chips/4.00
    t_chips_fte = t_chips/4.00    

   

    @c_st = TrackComment.where(str)

    %>
 
    <div class="col-sm d-flex">
      <div class="card">
      <div class="card-header">
        <h5><%= strategic.title %></h5>
        <% if (progress) %>
          <p>Cycle Progress: <%= total %>%</p>
        <% end %>
        <% if (fte) %>
          <p>Total FTE: <%= t_chips_fte.round(2) %></p>
        <% end %>
      </div>  
      <div class="card-body flex-fill">
         <% if (!strategic.short_description.nil?) %> 
           <p> <%= strategic.short_description.html_safe %></p>
         <% end %>
         
         <h6 ><strong> Objectives:</strong></h6>
         <% cnt = 0
        
           one = @c_st.first

           @o_st.all.each do |o| 
             obj = o.objective
             # get current status
             if (pos==1)
               ostatus = o.status1
             elsif (pos==2)
               ostatus = o.status2
             elsif (pos==3)
               ostatus = o.status3
             elsif (pos==4)
               ostatus = o.status4    
             end  

             cnt = cnt+1
         %>  
       
        <p style="padding-top:10px;"" ><%=cnt.to_s %>. <%= obj%></p>
      
        <% if (bar) %>  
        <div class="progress">
          <div class="progress-bar bg-info" role="progressbar" style="width: <%=ostatus%>%;" aria-valuenow="<%=ostatus%>" aria-valuemin="0" aria-valuemax="100"> <%=ostatus%>%
          </div>
        </div>
        <% end %>

       
      <% 
         end #objectives%>
       
      </div>      
      </div>
    </div>
     <% if (card_no.remainder(3)==0)
     %>
       </div>  <div class="row" style="padding-top:20px"> 
     <% end %>   
      <% end %>
      <div class="col-sm d-flex"></div>
  </div>





 </div>  
</div>




  
   
    